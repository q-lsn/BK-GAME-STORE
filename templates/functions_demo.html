<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Demo Gọi Hàm SQL</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="container">
        <h1>Demo Gọi Hàm SQL</h1>

        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                <ul class="flashes">
                {% for category, message in messages %}
                    <li class="{{ category }}">{{ message }}</li>
                {% endfor %}
                </ul>
            {% endif %}
        {% endwith %}

        <div class="function-section">
            <h2>Hàm CalculateUserSpending (Tổng chi tiêu User)</h2>
            <p>Tính tổng số tiền mà một người dùng đã chi tiêu trong một khoảng thời gian cụ thể.</p>

            <form action="{{ url_for('functions_demo') }}" method="post">
                <input type="hidden" name="action" value="call_func1">

                <div>
                    <label for="func1_user_id">User ID (CHAR(6), ví dụ: UI0001):</label><br>
                    <input type="text" id="func1_user_id" name="user_id" value="{{ func1_input.user_id if func1_input else '' }}" required>
                </div>

                <div>
                    <label for="func1_start_date">Ngày bắt đầu:</label><br>
                     <input type="date" id="func1_start_date" name="start_date" value="{{ func1_input.start_date if func1_input else '' }}" required>
                </div>

                <div>
                    <label for="func1_end_date">Ngày kết thúc:</label><br>
                    <input type="date" id="func1_end_date" name="end_date" value="{{ func1_input.end_date if func1_input else '' }}" required>
                </div>

                <button type="submit">Gọi Hàm 1</button>
            </form>

            {% if func1_result is not none %}
            <div class="results-area">
                <h3>Kết quả:</h3>
                 {% if func1_result.error %}
                    <p class="error-message">Lỗi: {{ func1_result.error }}</p>
                {% elif func1_result.success %}
                    <p>Tổng chi tiêu: {{ func1_result.total_spending | default(0.00) }}</p>
                {% else %}
                     <p>Không có kết quả.</p>
                {% endif %}
            </div>
            {% endif %}
        </div>

        <div class="function-section">
            <h2>Hàm CalculateAvrgReviewScore (Điểm đánh giá trung bình Game)</h2>
             <p>Tính toán điểm đánh giá trung bình, số lượng và phân loại đánh giá cho một game.</p>

            <form action="{{ url_for('functions_demo') }}" method="post">
                <input type="hidden" name="action" value="call_func2">

                <div>
                    <label for="func2_game_id">Game ID (CHAR(6), ví dụ: GA0001):</label><br>
                     <input type="text" id="func2_game_id" name="game_id" value="{{ func2_input.game_id if func2_input else '' }}" required>
                </div>

                <button type="submit">Gọi Hàm 2</button>
            </form>

             {% if func2_result is not none %}
            <div class="results-area">
                <h3>Kết quả:</h3>
                {% if func2_result.error %}
                    <p class="error-message">Lỗi: {{ func2_result.error }}</p>
                {% elif func2_result.success and func2_result.results %}
                     <table>
                         <thead>
                             <tr>
                                 {% for col in func2_result.results[0].keys() %}
                                     <th>{{ col }}</th>
                                 {% endfor %}
                             </tr>
                         </thead>
                         <tbody>
                             {% for row in func2_result.results %}
                                 <tr>
                                     {% for value in row.values() %}
                                         <td>{{ value | default('N/A') }}</td>
                                     {% endfor %}
                                 </tr>
                             {% endfor %}
                         </tbody>
                     </table>
                {% else %}
                     <p>Không có kết quả được trả về từ hàm.</p>
                {% endif %}
            </div>
            {% endif %}
        </div>

        <div class="back-link-container">
            <a href="{{ url_for('index') }}">Quay lại Trang Chủ</a>
        </div>

    </div>

     <script>
         window.addEventListener('load', function() {
            const flashMessages = document.querySelectorAll('.flashes li');
            flashMessages.forEach(msg => {
                setTimeout(() => {
                    msg.classList.add('fade-out');
                    setTimeout(() => {
                        msg.remove();
                    }, 500);
                }, 5000);
            });
        });
    </script>

</body>
</html>