<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Danh Sách Game - Hệ Cơ Sở Dữ Liệu</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <style>
        /* Style cụ thể cho index.html (Có thể chuyển một số sang style.css chung nếu muốn) */
        .header-container {
            max-width: 1000px;
            margin: 0 auto 30px auto;
            text-align: center;
        }

        .controls-container {
            max-width: 1000px;
            margin: 0 auto 20px auto;
            background-color: #f9f9f9; /* Sử dụng màu nền sáng hơn cho controls */
            padding: 15px;
            border-radius: 5px;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
            justify-content: flex-start;
             border: 1px solid #eee; /* Thêm border */
        }

        /* Style cho bảng danh sách game */
        .game-list-table {
             width: 100%;
             max-width: 1000px; /* Giới hạn chiều rộng bảng */
             margin: 0 auto;
             border-collapse: collapse;
             box-shadow: 0 2px 5px rgba(0,0,0,0.1); /* Thêm đổ bóng nhẹ cho bảng */
        }

        .game-list-table th,
        .game-list-table td {
             padding: 10px;
             border: 1px solid #ddd;
             text-align: left;
        }

        .game-list-table th {
             background-color: #f2f2f2;
             font-weight: bold;
             color: #333;
        }

        .game-list-table tbody tr:nth-child(even) {
             background-color: #f9f9f9; /* Màu nền xen kẽ cho dòng */
        }

         .game-list-table tbody tr:hover {
             background-color: #e9e9e9; /* Hiệu ứng hover cho dòng */
         }


        /* Style cho cột Actions trong bảng */
        .game-list-table .actions {
             white-space: nowrap; /* Ngăn wrap nội dung cột actions */
             text-align: center; /* Căn giữa nội dung cột actions */
        }
         .game-list-table .actions a,
         .game-list-table .actions span {
              margin: 0 5px; /* Khoảng cách giữa các action */
         }


        /* Style cho Modal (đã có style chung trong style.css) */
        /* #addGameModal, #editGameModal */


        /* Media query cho màn hình nhỏ */
        @media (max-width: 768px) {
             body {
                 padding: 10px;
             }
             .header-container,
             .controls-container,
             .game-list-table {
                 max-width: 100%; /* Cho phép sử dụng toàn bộ chiều rộng trên màn hình nhỏ */
                 margin: 0 auto 15px auto; /* Điều chỉnh margin */
             }

             .controls-container {
                 flex-direction: column;
                 align-items: stretch;
                 gap: 10px; /* Giảm khoảng cách */
             }

             .controls-container .button-link {
                 width: 100%;
                 box-sizing: border-box;
                 text-align: center;
             }

             /* Cho phép bảng cuộn ngang nếu nội dung quá rộng */
             .game-list-table {
                  overflow-x: auto;
                  display: block;
             }
             .game-list-table th,
             .game-list-table td {
                  white-space: nowrap; /* Ngăn wrap text trong ô */
                  padding: 8px; /* Giảm padding */
                  font-size: 0.9em; /* Giảm cỡ chữ */
             }
             .game-list-table .actions {
                  white-space: nowrap;
                  text-align: center;
             }
             .game-list-table .actions a,
             .game-list-table .actions span {
                 margin: 0 3px; /* Giảm khoảng cách */
             }

             /* Điều chỉnh modal trên màn hình nhỏ */
             .modal-content {
                 width: 95%;
                 margin: 5% auto;
                 padding: 15px;
             }
              input[type="text"],
              input[type="date"],
              input[type="number"],
              select,
              textarea {
                  width: calc(100% - 20px); /* Adjust padding */
              }

         }

    </style>
</head>
<body>

    <div class="header-container">
        <h1>Danh Sách Game</h1>
    </div>

    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            <ul class="flashes">
            {% for category, message in messages %}
                <li class="{{ category }}">{{ message }}</li>
            {% endfor %}
            </ul>
        {% endif %}
    {% endwith %}

    <div class="controls-container">
        <a href="#" class="button-link" id="addGameBtn">Thêm Game Mới</a>
        {# Có thể thêm các control khác ở đây sau (ví dụ: tìm kiếm, lọc) #}
    </div>

    {# Thay thế div game-list-grid bằng table #}
    {% if data %}
    <table class="game-list-table">
        <thead>
            <tr>
                {# THÊM CÁC CỘT HEADER BẠN MUỐN HIỂN THỊ #}
                <th>Game ID</th> {# Thêm cột Game ID #}
                <th>Game Name</th>
                <th>Engine</th>
                <th>Description</th> {# Thêm cột Description #}
                <th>Publisher ID</th> {# Cột ID nhà phát hành #}
                <th>Released Date</th>
                <th>Product ID</th> {# Thêm cột Product ID #}
            </tr>
        </thead>
        <tbody>
            {% for row in data %}
            <tr>
                {# THÊM CÁC Ô DỮ LIỆU (td) CHO TỪNG CỘT #}
                {# Đảm bảo key trong row[...] khớp với tên cột trả về từ SP #}
                <td>{{ row['game_id'] | default('N/A') }}</td> {# Hiển thị Game ID #}
                <td>{{ row['game_name'] | default('N/A') }}</td> {# Hiển thị Game Name #}
                <td>{{ row['engine'] | default('N/A') }}</td> {# Hiển thị Engine #}
                <td>{{ row['game_description'] | default('N/A') }}</td> {# Hiển thị Description #}
                <td>{{ row['game_publisher'] | default('N/A') }}</td> {# Hiển thị Publisher ID (key là 'game_publisher' từ SP của bạn) #}
                <td>{{ row['date_released'] | default("N/A") }}</td> {# Hiển thị Released Date #}
                <td>{{ row['product_id'] | default('N/A') }}</td> {# Hiển thị Product ID #}
                {# Thêm td cho các cột khác nếu có #}

                <td class="actions">
                    {# Nút Sửa: Sử dụng class edit-item-link và data attributes cần thiết cho modal sửa chung #}
                    {# Lấy data attributes từ row #}
                   <a href="#" class="edit-item-link"
                      data-type="game" {# Loại dữ liệu #}
                      data-id="{{ row['game_id'] | default('') }}" {# Game ID (VARCHAR) #}
                      data-game-name="{{ row['game_name'] | default('') }}" {# Game Name #}
                      >Sửa</a>
                    {# Nút Xóa: Sử dụng class delete-item-icon và data attributes cần thiết #}
                    {# api delete_game nhận item_id #}
                   <span class="delete-item-icon"
                         data-type="game" {# Loại dữ liệu #}
                         data-item-id="{{ row[''] | default('') }}">&times; Xóa</span> {# Game ID (VARCHAR) #}
               </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
     <p style="max-width: 1000px; margin: 20px auto; text-align: center; color: #555;">Không tìm thấy game nào.</p>
    {% endif %}

    {# --- Cấu trúc Modal Thêm Mới Game (Giữ nguyên) --- #}
    {# Modal này sử dụng ID addGameModal và các input id/name cụ thể #}
    <div id="addGameModal" class="modal">
        <div class="modal-content">
            <span class="close-button add-close">&times;</span>
            <h2>Thêm Game Mới</h2>
            <form id="addGameForm" action="{{ url_for('add_game_api') }}" method="post">
                 <div>
                    <label for="g_name">Game Name:</label><br>
                    <input type="text" id="g_name" name="g_name" required>
                </div>
                <br>
                <div>
                    <label for="g_engine">Engine:</label><br>
                    <input type="text" id="g_engine" name="g_engine">
                </div>
                <br>
                 <div>
                    <label for="g_description">Description:</label><br>
                    <textarea id="g_description" name="g_description"></textarea>
                </div>
                <br>
                 <div>
                    <label for="publisher_id">Publisher ID:</label><br> {# SP InsertGame nhận Publisher ID #}
                    <input type="text" id="publisher_id" name="p_id" required> {# Sử dụng name="p_id" khớp với API #}
                </div>
                <br>
                 <div>
                    <label for="released">Released Date:</label><br>
                    <input type="date" id="released" name="released">
                </div>
                 <br>
                {# Nếu SP InsertGame mới nhận price/tradeable, thêm các input này #}
                {#
                <div>
                    <label for="product_price">Price:</label><br>
                    <input type="number" id="product_price" name="product_price" step="0.01" min="0" value="0.00">
                </div>
                 <br>
                 <div>
                     <label for="tradeable">Tradeable:</label><br>
                     <select id="tradeable" name="tradeable" required>
                          <option value="0">No</option>
                          <option value="1">Yes</option>
                     </select>
                 </div>
                 <br>
                #}

                <button type="submit">Lưu Game</button>
                <button type="button" class="cancel-button add-cancel">Hủy</button>
            </form>
        </div>
    </div>

    <div id="editGameModal" class="modal">
         <div class="modal-content">
             <span class="close-button edit-close">&times;</span>
             <h2>Sửa Thông Tin Game</h2>

             <form id="editGameForm" action="{{ url_for('update_game_api') }}" method="post">
                  <input type="hidden" id="edit_game_id" name="game_id"> {# Input ẩn cho Game ID #}

                  <div>
                     <label for="edit_g_name">Game Name:</label><br>
                     <input type="text" id="edit_g_name" name="g_name" required>
                 </div>
                 <br>

                  <div>
                     <label for="edit_g_description">Description:</label><br>
                     <textarea id="edit_g_description" name="g_description"></textarea>
                 </div>
                 <br>
                 {# Nếu UpdateGameInfo SP mới nhận price/tradeable, thêm các input này #}
                 {#
                 <div>
                     <label for="edit_product_price">Price:</label><br>
                     <input type="number" id="edit_product_price" name="product_price" step="0.01" min="0">
                 </div>
                 <br>
                  <div>
                      <label for="edit_tradeable">Tradeable:</label><br>
                      <select id="edit_tradeable" name="tradeable" required>
                          <option value="0">No</option>
                          <option value="1">Yes</option>
                      </select>
                  </div>
                  <br>
                 #}

                 <button type="submit">Lưu Thay Đổi</button>
                 <button type="button" class="cancel-button edit-cancel">Hủy</button>
             </form>

         </div>
     </div>


    <script>
        // --- Lấy các phần tử DOM cho cả hai Modal Game ---
        // Modal Thêm Mới
        var addModal = document.getElementById("addGameModal");
        var addBtn = document.getElementById("addGameBtn");
        var addCloseSpan = addModal ? addModal.querySelector(".close-button") : null;
        var addCancelButton = addModal ? addModal.querySelector(".cancel-button") : null;
        var addForm = document.getElementById("addGameForm");

        // Modal Sửa Game
        var editModal = document.getElementById("editGameModal");
        var editCloseSpan = editModal ? editModal.querySelector(".close-button") : null;
        var editCancelButton = editModal ? editModal.querySelector(".cancel-button") : null;
        var editForm = document.getElementById("editGameForm");
        var editGameIdInput = document.getElementById("edit_game_id");
        var editGameNameInput = document.getElementById("edit_g_name");
        var editGameDescriptionInput = document.getElementById("edit_g_description");
        // Thêm lấy input price/tradeable nếu có trong form sửa
        // var editProductPriceInput = document.getElementById("edit_product_price");
        // var editTradeableInput = document.getElementById("edit_tradeable");


        // Lấy tất cả các link "Sửa" và icon "Xóa" trong bảng game
        // Cập nhật selector để tìm trong bảng
        var editLinks = document.querySelectorAll(".game-list-table .actions .edit-item-link"); // Sử dụng class mới edit-item-link
        var deleteIcons = document.querySelectorAll(".game-list-table .actions .delete-item-icon"); // Sử dụng class mới delete-item-icon


        // --- Hàm để Hiện/Ẩn Modal (chung) ---
        function showModal(modalElement) {
             if (modalElement) {
                  modalElement.style.display = "block";
                  // modalElement.classList.add('show'); // Giữ lại class 'show' nếu cần animation CSS
              }
        }

        function hideModal(modalElement) {
             if (modalElement) {
                 // modalElement.classList.remove('show'); // Giữ lại class 'show' nếu cần animation CSS
                 modalElement.style.display = "none";
                 // Reset form tương ứng khi đóng modal
                 const form = modalElement.querySelector('form');
                 if (form) {
                      form.reset();
                 }
             }
        }


        // --- Xử lý sự kiện Hiện/Ẩn cho Modal Thêm Game ---
        if(addBtn && addModal) { // Chỉ gán nếu các phần tử tồn tại
             addBtn.onclick = function(event) {
                 event.preventDefault();
                 showModal(addModal);
             }
             if(addCloseSpan) addCloseSpan.onclick = function() { hideModal(addModal); }
             if(addCancelButton) addCancelButton.onclick = function() { hideModal(addModal); }
        }


        // --- Xử lý sự kiện Hiện/Ẩn cho Modal Sửa Game và Đọc dữ liệu từ HTML ---
        if(editLinks && editModal) { // Chỉ gán nếu các phần tử tồn tại
            editLinks.forEach(link => {
                link.onclick = function(event) {
                    event.preventDefault();

                    // --- Đọc dữ liệu game từ data attribute của link ---
                    // Lấy data attributes trực tiếp từ link Sửa
                    const gameId = link.getAttribute('data-id');
                    const gameName = link.getAttribute('data-game-name');
                    const gameDescription = link.getAttribute('data-game-description');
                    // Lấy data attributes price/tradeable nếu có
                    // const productPrice = link.getAttribute('data-product-price');
                    // const tradeable = link.getAttribute('data-tradeable');


                    if (!gameId) {
                         alert("Lỗi: Không lấy được Game ID từ HTML.");
                         return;
                    }

                    // Reset form sửa game trước khi điền dữ liệu mới
                    if(editForm) editForm.reset();

                    // --- Điền dữ liệu vào form sửa modal Game ---
                    if(editGameIdInput) editGameIdInput.value = gameId;
                    if(editGameNameInput) editGameNameInput.value = gameName !== null ? gameName : '';
                    if(editGameDescriptionInput) editGameDescriptionInput.value = gameDescription !== null ? gameDescription : '';
                    // Điền data price/tradeable nếu có
                    // if(editProductPriceInput) editProductPriceInput.value = productPrice !== null ? productPrice : '';
                    // if(editTradeableInput) editTradeableInput.value = tradeable !== null ? tradeable : '';


                    // Hiện modal sửa game
                    showModal(editModal);
                }
            });

            if(editCloseSpan) editCloseSpan.onclick = function() { hideModal(editModal); }
            if(editCancelButton) editCancelButton.onclick = function() { hideModal(editModal); }
        }


        // --- Xử lý sự kiện Nhấp ra ngoài Modal ---
         // Phải kiểm tra các modal có tồn tại trên trang không
        window.onclick = function(event) {
             const addModal = document.getElementById("addGameModal");
             const editModal = document.getElementById("editGameModal");
             // TODO: Thêm xử lý cho modal sửa chung (genericEditModal) nếu dùng

             if (addModal && event.target == addModal) { hideModal(addModal); }
             if (editModal && event.target == editModal) { hideModal(editModal); }
             // if (genericEditModal && event.target == genericEditModal) { hideModal(genericEditModal); }
        }


        // --- JavaScript để Xử lý Form Thêm Mới bằng AJAX ---
        if(addForm) { // Chỉ gán nếu form tồn tại
             addForm.onsubmit = function(event) {
                 event.preventDefault();

                 var formData = new FormData(addForm);

                 fetch(addForm.action, {
                     method: 'POST',
                     body: formData
                 })
                 .then(response => {
                     if (!response.ok) {
                         // Handle non-JSON errors if necessary, but assume JSON error format for API
                         return response.json().then(data => {
                             throw new Error(data.error || `HTTP error! Status: ${response.status}`);
                         }).catch(() => { // Catch JSON parse error on non-ok response
                             return response.text().then(text => {
                                 throw new Error(`Non-JSON error response: ${response.status} ${response.statusText} - ${text.substring(0, 200)}...`);
                             });
                         });
                     }
                     // Handle potential non-JSON success responses if necessary
                     return response.json().catch(() => { // Catch JSON parse error on ok response
                         return response.text().then(text => {
                              throw new Error(`Unexpected non-JSON success response: ${response.status} ${response.statusText} - ${text.substring(0, 200)}...`);
                         });
                     });
                 })
                 .then(data => {
                     if (data.success) {
                         alert(data.message || "Game added successfully!");
                         hideModal(addModal);
                         window.location.reload(); // Tải lại trang để cập nhật danh sách
                     } else {
                          alert("Error: " + (data.error || "Failed to add game."));
                     }
                 })
                 .catch(error => {
                     console.error('Error:', error);
                     alert("An error occurred: " + error.message);
                 });
             };
        }


        // --- JavaScript để Xử lý Form Sửa Game bằng AJAX ---
         if(editForm) { // Chỉ gán nếu form tồn tại
             editForm.onsubmit = function(event) {
                 event.preventDefault();

                 var formData = new FormData(editForm);
                 // FormData tự động bao gồm input ẩn edit_game_id

                 fetch(editForm.action, { // Action trỏ đến update_game_api
                     method: 'POST',
                     body: formData
                 })
                 .then(response => {
                     if (!response.ok) {
                          // Handle non-JSON errors if necessary
                          return response.json().then(data => {
                              throw new Error(data.error || `HTTP error! Status: ${response.status}`);
                          }).catch(() => { // Catch JSON parse error on non-ok response
                             return response.text().then(text => {
                                 throw new Error(`Non-JSON error response: ${response.status} ${response.statusText} - ${text.substring(0, 200)}...`);
                             });
                         });
                     }
                      // Handle potential non-JSON success responses
                     return response.json().catch(() => { // Catch JSON parse error on ok response
                          return response.text().then(text => {
                              throw new Error(`Unexpected non-JSON success response: ${response.status} ${response.statusText} - ${text.substring(0, 200)}...`);
                          });
                     });
                 })
                 .then(data => {
                     if (data.success) {
                         alert(data.message || "Game updated successfully!");
                         hideModal(editModal);
                         window.location.reload(); // Tải lại trang để cập nhật danh sách
                     } else {
                         alert("Error: " + (data.error || "Failed to update game."));
                     }
                 })
                 .catch(error => {
                     console.error('Error:', error);
                     alert("An error occurred while updating the game: " + error.message);
                 });
             };
         }


        // --- JavaScript để Xử lý Xóa Game bằng AJAX ---
         if(deleteIcons) { // Chỉ gán nếu các icon tồn tại
             deleteIcons.forEach(icon => {
                 icon.onclick = function(event) {
                     event.preventDefault();

                     // Lấy Game ID từ data attribute của icon
                     // **LƯU Ý:** API delete_game_api nhận 'item_id'
                     const itemId = icon.getAttribute('data-item-id');

                     if (!itemId) {
                          alert("Lỗi: Không lấy được Game ID để xóa.");
                          return;
                     }

                     // Xác nhận trước khi xóa
                     if (confirm('Bạn có chắc chắn muốn xóa game này không?')) {
                         // Gửi yêu cầu AJAX để xóa
                         const formData = new FormData();
                         formData.append('item_id', itemId); // Gửi dưới tên 'item_id' theo API

                         fetch("{{ url_for('delete_game_api') }}", { // URL của route API xóa game
                             method: 'POST',
                             body: formData
                         })
                         .then(response => {
                             if (!response.ok) {
                                  // Handle non-JSON errors if necessary
                                 return response.json().then(data => {
                                     throw new Error(data.error || `HTTP error! Status: ${response.status}`);
                                 }).catch(() => { // Catch JSON parse error on non-ok response
                                     return response.text().then(text => {
                                         throw new Error(`Non-JSON error response: ${response.status} ${response.statusText} - ${text.substring(0, 200)}...`);
                                     });
                                 });
                             }
                             // Handle potential non-JSON success responses
                             return response.json().catch(() => { // Catch JSON parse error on ok response
                                  return response.text().then(text => {
                                      throw new Error(`Unexpected non-JSON success response: ${response.status} ${response.statusText} - ${text.substring(0, 200)}...`);
                                  });
                             });
                         })
                         .then(data => {
                             if (data.success) {
                                 alert(data.message || "Game deleted successfully!");
                                 window.location.reload(); // Tải lại trang để cập nhật danh sách
                             } else {
                                 alert("Error: " + (data.error || "Failed to delete game."));
                             }
                         })
                         .catch(error => {
                             console.error('Error:', error);
                             alert("An error occurred while deleting the game: " + error.message);
                         });
                     }
                 }
             });
         }

    </script>


</body>
</html>