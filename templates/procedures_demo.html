<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Demo Gọi Thủ Tục SQL</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <style>
        /* Style cụ thể cho procedures_demo.html */

        /* Media query cho màn hình nhỏ */
        @media (max-width: 768px) {
             body {
                 padding: 10px;
             }
             .container {
                 max-width: 100%;
             }
              .content-section { /* Tên chung */
                  padding: 15px;
              }
              .content-section form input[type="text"],
              .content-section form input[type="date"],
              .content-section form input[type="number"],
              .content-section form select,
              .content-section form textarea {
                  width: calc(100% - 20px);
              }
               .results-area table th,
                .results-area table td {
                    padding: 6px;
                }
                .results-area table { /* Cho phép bảng cuộn ngang trên màn hình nhỏ */
                    overflow-x: auto;
                    display: block;
                }
                .results-area table th, .results-area table td {
                     white-space: nowrap; /* Giữ nowrap trong ô khi cuộn */
                }
                .results-area table td.actions {
                     min-width: 80px; /* Đảm bảo đủ rộng */
                }
         }

    </style>
</head>
<body>
    <div class="container">
        <h1>Demo Gọi Thủ Tục SQL</h1>

        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                <ul class="flashes">
                {% for category, message in messages %}
                    <li class="{{ category }}">{{ message }}</li>
                {% endfor %}
                </ul>
            {% endif %}
        {% endwith %}

        <div class="content-section"> {# Sử dụng class chung #}
            <h2>Thủ tục best_seller (Top Game Bán Chạy)</h2>
            <p>Lấy danh sách các game bán chạy nhất, có thể lọc theo tag và nhà phát hành. Chức năng Sửa/Xóa hoạt động trên danh sách này.</p>

            <form action="{{ url_for('procedures_demo') }}" method="post">
                <input type="hidden" name="action" value="call_best_seller">

                <div>
                    <label for="best_seller_tag">Game Tag (ví dụ: Action):</label><br>
                    <input type="text" id="best_seller_tag" name="game_tags" value="{{ best_seller_input.game_tags if best_seller_input else '' }}">
                </div>

                <div>
                    <label for="best_seller_publisher">Publisher Name (ví dụ: Valve):</label><br>
                    <input type="text" id="best_seller_publisher" name="g_publisher" value="{{ best_seller_input.g_publisher if best_seller_input else '' }}">
                </div>

                 <div>
                    <label for="bs_search">Tìm kiếm (Tên Game, Publisher):</label><br>
                    <input type="text" id="bs_search" name="bs_search" value="{{ bs_search_query if bs_search_query else '' }}" placeholder="Tìm kiếm...">
                </div>

                 <div>
                    <label for="bs_sort">Sắp xếp theo:</label><br>
                    <select id="bs_sort" name="bs_sort">
                        <option value="GameName" {{ 'selected' if bs_sort_by == 'GameName' else '' }}>Tên Game</option>
                        <option value="Price" {{ 'selected' if bs_sort_by == 'Price' else '' }}>Giá</option>
                        <option value="date_released" {{ 'selected' if bs_sort_by == 'date_released' else '' }}>Ngày phát hành</option>
                        <option value="unit_sold" {{ 'selected' if bs_sort_by == 'unit_sold' else '' }}>Số lượng bán</option>
                        {# Thêm các cột khác từ kết quả best_seller nếu cần #}
                    </select>
                </div>


                <button type="submit">Tìm Kiếm Game Bán Chạy</button>
            </form>

            {% if best_seller_data is not none %}
            <div class="results-area">
                <h3>Kết quả Thủ tục best_seller:</h3>
                 {% if best_seller_data %}
                     <table>
                         <thead>
                             <tr>
                                 {% for col in best_seller_data[0].keys() %}
                                      {# Ẩn cột game_id trong header #}
                                     {% if col != 'game_id' %}
                                         <th>{{ col }}</th>
                                     {% endif %}
                                 {% endfor %}
                                  <th>Actions</th> {# Cột cho các nút Sửa/Xóa #}
                             </tr>
                         </thead>
                         <tbody>
                             {% for row in best_seller_data %}
                                 <tr>
                                     {% for key, value in row.items() %}
                                          {# Cột game_id (cột đầu tiên) ẩn #}
                                          {% if key == 'game_id' %}
                                               <td style="display:none;">{{ value | default('') }}</td> {# Ẩn ID nhưng vẫn có trong HTML #}
                                          {% else %}
                                              <td>{{ value | default('N/A') }}</td>
                                          {% endif %}
                                     {% endfor %}
                                      <td class="actions">
                                           {# Nút Sửa Game: Sử dụng class edit-item-link, data-type="game", data-id="game_id" #}
                                           {# Data attributes cho các trường sửa được bằng UpdateGameInfo: Name, Price, Description #}
                                           {# best_seller không trả về description, không sửa description từ view này #}
                                           <a href="#" class="edit-item-link"
                                              data-type="game"
                                              data-id="{{ row.game_id | default('') }}"
                                              data-game-name="{{ row.GameName | default('') }}"
                                              data-game-price="{{ row.Price | default('') }}">
                                              Sửa</a> |
                                           {# Nút Xóa Game: Sử dụng class delete-item-icon, data-type="game", data-id="game_id" #}
                                           <span class="delete-item-icon"
                                                 data-type="game"
                                                 data-id="{{ row.game_id | default('') }}">&times;</span>
                                      </td>
                                 </tr>
                             {% endfor %}
                         </tbody>
                     </table>
                 {% else %}
                     <p>Không tìm thấy kết quả nào.</p>
                 {% endif %}
            </div>
            {% endif %}
        </div>

        <div class="content-section"> {# Sử dụng class chung #}
            <h2>Thủ tục CommentFilter (Lọc Đánh Giá Game)</h2>
             <p>Lấy các đánh giá cho một game với điểm số lớn hơn hoặc bằng điểm tối thiểu. Chức năng Sửa/Xóa hoạt động trên danh sách này.</p>
             <p class="limitation-note"><strong>Lưu ý:</strong> Cột ReviewID được thêm vào kết quả nhưng không hiển thị trực tiếp trên bảng.</p>


            <form action="{{ url_for('procedures_demo') }}" method="post">
                <input type="hidden" name="action" value="call_comment_filter">

                <div>
                    <label for="comment_filter_game_name">Game Name (ví dụ: Dota 2):</label><br>
                     <input type="text" id="comment_filter_game_name" name="game_name" value="{{ comment_filter_input.game_name if comment_filter_input else '' }}" required>
                </div>

                <div>
                    <label for="comment_filter_min_score">Minimum Score (1-10):</label><br>
                     <input type="number" id="comment_filter_min_score" name="minimum_score" value="{{ comment_filter_input.minimum_score if comment_filter_input else '' }}" min="1" max="10" required>
                </div>

                 <div>
                    <label for="cf_search">Tìm kiếm (User, Bình luận):</label><br>
                    <input type="text" id="cf_search" name="cf_search" value="{{ cf_search_query if cf_search_query else '' }}" placeholder="Tìm kiếm...">
                </div>

                 <div>
                    <label for="cf_sort">Sắp xếp theo:</label><br>
                    <select id="cf_sort" name="cf_sort">
                        <option value="rating_score" {{ 'selected' if cf_sort_by == 'rating_score' else '' }}>Điểm Đánh Giá</option>
                         <option value="user_name" {{ 'selected' if cf_sort_by == 'user_name' else '' }}>Tên User</option>
                         <option value="comment" {{ 'selected' if cf_sort_by == 'comment' else '' }}>Bình luận</option>
                         {# Thêm các cột khác từ kết quả CommentFilter nếu cần #}
                    </select>
                </div>


                <button type="submit">Lọc Đánh Giá</button>
            </form>

             {% if comment_filter_data is not none %}
            <div class="results-area">
                <h3>Kết quả Thủ tục CommentFilter:</h3>
                 {% if comment_filter_data %}
                     <table>
                         <thead>
                             <tr>
                                 {% for col in comment_filter_data[0].keys() %}
                                     {# Ẩn cột ReviewID trong header #}
                                     {% if col != 'ReviewID' %}
                                         <th>{{ col }}</th>
                                     {% endif %}
                                 {% endfor %}
                                 <th>Actions</th> {# Cột cho nút Sửa/Xóa #}
                             </tr>
                         </thead>
                         <tbody>
                             {% for row in comment_filter_data %}
                                 <tr>
                                     {% for key, value in row.items() %}
                                          {# Cột ReviewID (cột đầu tiên) ẩn #}
                                          {% if key == 'ReviewID' %}
                                               <td style="display:none;">{{ value | default('') }}</td> {# Ẩn ID nhưng vẫn có trong HTML #}
                                          {% else %}
                                              <td>{{ value | default('N/A') }}</td>
                                          {% endif %}
                                     {% endfor %}
                                     <td class="actions">
                                          {# Nút Sửa Review: Sử dụng class edit-item-link, data-type="review", data-id="ReviewID" #}
                                         <a href="#" class="edit-item-link"
                                            data-type="review"
                                            data-id="{{ row.ReviewID if row.ReviewID else '' }}"
                                            data-comment="{{ row.comment | default('') }}"
                                            data-rating-score="{{ row.rating_score if row.rating_score is not none else '' }}">Sửa</a> |
                                          {# Nút Xóa Review: Sử dụng class delete-item-icon, data-type="review", data-id="ReviewID" #}
                                         <span class="delete-item-icon"
                                               data-type="review"
                                               data-id="{{ row.ReviewID if row.ReviewID else '' }}">&times;</span>
                                      </td>
                                 </tr>
                             {% endfor %}
                         </tbody>
                     </table>
                 {% else %}
                     <p>Không tìm thấy kết quả nào.</p>
                 {% endif %}
            </div>
            {% endif %}
        </div>

        <div class="back-link-container">
            <a href="{{ url_for('index') }}">Quay lại Trang Chủ</a>
        </div>

    </div>

     {# Sử dụng một modal chung cho cả sửa Game và sửa Review #}
     <div id="genericEditModal" class="modal">
         <div class="modal-content">
             <span class="close-button generic-edit-close">&times;</span>
             <h2 id="genericEditModalTitle">Sửa Dữ Liệu</h2>

             <form id="genericEditForm" action="" method="post"> {# action sẽ được JS đặt khi mở modal #}
                 <input type="hidden" name="data_type" id="generic_edit_data_type"> {# Lưu loại dữ liệu (game/review) #}
                 <input type="hidden" name="id" id="generic_edit_id"> {# Lưu ID chính (GameID hoặc ReviewID) #}

                 {# Container cho các trường nhập liệu động #}
                 <div id="genericEditFields">
                     {# Các trường nhập liệu sẽ được thêm/hiển thị bằng JS #}
                 </div>

                 <button type="submit">Lưu Thay Đổi</button>
                 <button type="button" class="cancel-button generic-edit-cancel">Hủy</button>
             </form>
         </div>
     </div>


    <script>
         // --- Hàm cho hiệu ứng mờ dần thông báo flash (loại bỏ nếu muốn đơn giản) ---
        window.addEventListener('load', function() {
            const flashMessages = document.querySelectorAll('.flashes li');
            // Loại bỏ hiệu ứng mờ dần
            // flashMessages.forEach(msg => {
            //     setTimeout(() => {
            //         msg.classList.add('fade-out');
            //         setTimeout(() => {
            //             msg.remove();
            //         }, 500);
            //     }, 5000);
            // });
             // Chỉ hiển thị thông báo cho đến khi trang reload hoặc điều hướng
        });

        // --- Lấy các phần tử DOM cho Modal Sửa Chung ---
        var genericEditModal = document.getElementById("genericEditModal");
        var genericEditCloseSpan = genericEditModal.querySelector(".close-button");
        var genericEditCancelButton = genericEditModal.querySelector(".cancel-button");
        var genericEditForm = document.getElementById("genericEditForm");
        var genericEditModalTitle = document.getElementById("genericEditModalTitle");
        var genericEditDataTypeInput = document.getElementById("generic_edit_data_type");
        var genericEditIdInput = document.getElementById("generic_edit_id");
        var genericEditFieldsContainer = document.getElementById("genericEditFields");


         // --- Hàm để Hiện/Ẩn Modal (chung) ---
        function showModal(modalElement) {
            modalElement.style.display = "block";
             // Bỏ hiệu ứng show/transform
             // modalElement.classList.add('show');
        }

        function hideModal(modalElement) {
             // Bỏ hiệu ứng hide/transform
             // modalElement.classList.remove('show');
            modalElement.style.display = "none";
            // Reset form khi đóng
            modalElement.querySelector('form').reset();
             // Xóa các trường nhập liệu cũ trong modal sửa chung
            if(modalElement.id === 'genericEditModal') {
                genericEditFieldsContainer.innerHTML = '';
            }
        }

        // --- Xử lý sự kiện Nhấp ra ngoài Modal ---
        window.onclick = function(event) {
            if (event.target == genericEditModal) { hideModal(genericEditModal); }
        }


        // --- JavaScript để Xử lý Xóa Item (Game hoặc Review) bằng AJAX ---
        // Sử dụng class chung delete-item-icon
        var deleteItemIcons = document.querySelectorAll(".delete-item-icon");
        deleteItemIcons.forEach(icon => {
            icon.onclick = function(event) {
                event.preventDefault();

                // Lấy ID và loại dữ liệu từ data attributes
                const itemId = icon.getAttribute('data-id'); // GameID hoặc ReviewID
                const dataType = icon.getAttribute('data-type'); // 'game' hoặc 'review'

                if (!itemId || !dataType) {
                     alert("Lỗi: Thiếu thông tin ID hoặc loại dữ liệu để xóa.");
                     return;
                }

                // Xác nhận trước khi xóa
                if (confirm(`Bạn có chắc chắn muốn xóa ${dataType === 'game' ? 'game' : 'đánh giá'} này không?`)) {
                    // Gửi yêu cầu AJAX để xóa
                    const formData = new FormData();
                    // Tên param ID phụ thuộc vào backend route
                    let deleteUrl;
                    if (dataType === 'game') {
                        deleteUrl = "{{ url_for('delete_game_api') }}"; // Route API xóa Game
                        formData.append('item_id', itemId); // update_game_api nhận 'item_id'
                    } else if (dataType === 'review') {
                        deleteUrl = "{{ url_for('delete_review_api') }}"; // Route API xóa Review
                        formData.append('review_id', itemId); // delete_review_api nhận 'review_id'
                    } else {
                         alert("Loại dữ liệu không xác định để xóa.");
                         return;
                    }


                    fetch(deleteUrl, { // URL của route API xóa
                        method: 'POST', // Sử dụng POST
                        body: formData
                    })
                     .then(response => {
                         if (!response.ok) {
                             return response.json().then(data => {
                                throw new Error(data.error || `HTTP error! Status: ${response.status}`);
                            });
                        }
                        return response.json();
                    })
                    .then(data => {
                        if (data.success) {
                            alert(data.message || "Mục đã được xóa thành công!");
                            window.location.reload(); // Tải lại trang để cập nhật danh sách
                        } else {
                             alert(`Lỗi xóa ${dataType === 'game' ? 'game' : 'đánh giá'}: ` + (data.error || "Xóa thất bại."));
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert(`Đã xảy ra lỗi khi xóa ${dataType === 'game' ? 'game' : 'đánh giá'}: ` + error.message);
                    });
                }
            }
        });


        // --- JavaScript để Xử lý Form Sửa (Game hoặc Review) bằng AJAX (Generic Edit Modal) ---
        // Sử dụng class chung edit-item-link
        var editItemLinks = document.querySelectorAll(".edit-item-link");
        editItemLinks.forEach(link => {
             link.onclick = function(event) {
                 event.preventDefault();

                // Lấy ID và loại dữ liệu từ data attributes của link
                const itemId = link.getAttribute('data-id'); // GameID hoặc ReviewID
                const dataType = link.getAttribute('data-type'); // 'game' hoặc 'review'

                 if (!itemId || !dataType) {
                     alert("Lỗi: Thiếu thông tin ID hoặc loại dữ liệu để sửa.");
                     return;
                 }

                 // Reset form sửa chung trước khi điền dữ liệu
                 genericEditForm.reset();
                 // Xóa các trường nhập liệu cũ
                 genericEditFieldsContainer.innerHTML = '';


                 // --- Cấu hình Modal Sửa Chung dựa trên loại dữ liệu ---
                 genericEditDataTypeInput.value = dataType; // Lưu loại dữ liệu vào input ẩn
                 genericEditIdInput.value = itemId; // Lưu ID vào input ẩn


                 if (dataType === 'game') {
                     genericEditModalTitle.textContent = 'Sửa Thông Tin Game';
                     genericEditForm.action = "{{ url_for('update_game_api') }}"; // Action cho sửa Game

                     // Lấy dữ liệu game từ data attributes
                     const gameName = link.getAttribute('data-game-name') || '';
                     const gamePrice = link.getAttribute('data-game-price') || '';
                      // best_seller không trả về description, không sửa description từ view này
                      // const gameDescription = link.getAttribute('data-game-description') || '';

                     // Tạo các trường nhập liệu cho sửa Game (Tên, Giá)
                     genericEditFieldsContainer.innerHTML = `
                         <div>
                             <label for="generic_edit_g_name">Game Name:</label><br>
                             <input type="text" id="generic_edit_g_name" name="g_name" value="${gameName}" required> {# Require Game Name #}
                         </div>
                         <br>
                         <div>
                             <label for="generic_edit_g_price">Price:</label><br>
                             <input type="text" id="generic_edit_g_price" name="g_price" value="${gamePrice}"> {# Price có thể rỗng hoặc số #}
                         </div>
                         <br>
                          {# Nếu muốn sửa description, thêm trường này và đảm bảo data-game-description có dữ liệu #}
                          {#
                         <div>
                             <label for="generic_edit_g_description">Description:</label><br>
                             <textarea id="generic_edit_g_description" name="g_description">${gameDescription}</textarea>
                         </div>
                         <br>
                         #}
                     `;

                 } else if (dataType === 'review') {
                     genericEditModalTitle.textContent = 'Sửa Đánh Giá';
                     genericEditForm.action = "{{ url_for('update_review_api') }}"; // Action cho sửa Review

                      // Lấy dữ liệu review từ data attributes
                     const reviewComment = link.getAttribute('data-comment') || '';
                     const reviewRatingScore = link.getAttribute('data-rating-score') || ''; // Có thể là chuỗi rỗng hoặc null

                     // Tạo các trường nhập liệu cho sửa Review (Bình luận, Điểm số)
                     genericEditFieldsContainer.innerHTML = `
                         <div>
                             <label for="generic_edit_comment">Comment:</label><br>
                             <textarea id="generic_edit_comment" name="comment">${reviewComment}</textarea>
                         </div>
                         <br>
                         <div>
                             <label for="generic_edit_rating_score">Rating Score (1-10):</label><br>
                             <input type="number" id="generic_edit_rating_score" name="rating_score" value="${reviewRatingScore}" min="1" max="10" required>
                         </div>
                         <br>
                     `;

                 } else {
                     alert("Loại dữ liệu không xác định để sửa.");
                     return;
                 }

                 // Hiển thị modal sửa chung
                 showModal(genericEditModal);
             }
        });

        if(genericEditForm) {
             genericEditForm.onsubmit = function(event) {
                 event.preventDefault();

                 var formData = new FormData(genericEditForm);
                 const dataType = genericEditDataTypeInput.value; // Lấy loại dữ liệu từ input ẩn
                 const itemId = genericEditIdInput.value; // Lấy ID từ input ẩn

                 // Backend API route (đã được đặt trong handler link.onclick)
                 const formActionUrl = genericEditForm.action;

                 // Điều chỉnh formData: đảm bảo tên param ID đúng với backend API
                 // update_game_api nhận 'game_id', update_review_api nhận 'review_id'.
                 // Form hiện tại gửi 'id'. Cần sửa tên key trong formData.
                 // FormData.append sẽ thêm key mới, FormData.set sẽ ghi đè nếu key tồn tại.
                 // Generic form hiện đã có input hidden name="id", cần đổi tên key đó.
                 // Cách đơn giản: xóa key 'id' và thêm lại với tên đúng.
                 formData.delete('id'); // Xóa key 'id'

                 if (dataType === 'game') {
                     formData.append('game_id', itemId); // Thêm lại với tên 'game_id' cho update_game_api
                 } else if (dataType === 'review') {
                     formData.append('review_id', itemId); // Thêm lại với tên 'review_id' cho update_review_api
                 }


                 fetch(formActionUrl, {
                     method: 'POST',
                     body: formData
                 })
                 .then(response => {
                     if (!response.ok) {
                          return response.json().then(data => {
                              throw new Error(data.error || `HTTP error! Status: ${response.status}`);
                         });
                     }
                     return response.json();
                 })
                 .then(data => {
                     if (data.success) {
                         alert(data.message || "Dữ liệu đã được cập nhật thành công!");
                         hideModal(genericEditModal);
                         window.location.reload(); // Tải lại trang để cập nhật danh sách
                     } else {
                         alert("Lỗi cập nhật: " + (data.error || "Cập nhật thất bại."));
                     }
                 })
                 .catch(error => {
                     console.error('Error:', error);
                     alert("Đã xảy ra lỗi khi cập nhật: " + error.message);
                 });
             };
        }

    </script>

</body>
</html>